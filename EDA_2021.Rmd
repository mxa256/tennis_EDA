---
title: "EDA 2021 ATP Tour"
author: "Mona Ascha"
date: "`Last Edited r format(Sys.time(), '%d %B %Y'`"
output: html_document
---
#Load packages
```{r}

library(Hmisc)
library(ggplot2)
library(tidyverse)
library(knitr)
library(dplyr)
library(statsr)
library(tableone)
library(forcats)
library(pander)
library(lubridate)
library(broom)
library(dplyr)
library(naniar)
library(finalfit) 

```

#Read in data
```{r}

filepath <- "/Users/mona/Desktop/Tennis_Analytics/tennis_atp-master/atp_matches_2021.csv"

data <- read.csv(filepath)

filepath1 <- "/Users/mona/Desktop/Tennis_Analytics/tennis_atp-master/atp_players.csv"

players <- read.csv(filepath1)
#download.file("https://raw.github.com/aronlindberg/latent_growth_classes/master/LGC_data.csv", 
#    destfile = "/tmp/test.csv", method = "curl")

```


##EDA

```{r}
#Data structure
str(data)
str(players)

# Examine with ff_glimpse
ff_glimpse(data)

```

##Missing data

```{r}
#This allows us to find the number of missing values for each individual question
missingfxn <- function(x){
    print(100*sum(is.na(x))/length(x))
}

#This dataframe tells us the percentage of each variable that is missing in the data set
missingdf <- as.data.frame(lapply(data, missingfxn))
datanames <- names(data)
missingdf <- rbind(datanames, missingdf)
missingdf <- t(missingdf)
missingdf %>% View() #This table is the percent missing values for each variable

#Let's toy around with the naniar package functions
n_miss(data)
prop_miss(data)
data %>% is.na() %>% colSums()
miss_var_summary(data) %>% View() #This is pretty much the same info as the missing df

# Get number of missings per participant (n and %)
miss_case_summary(data) #For each row, it tells us how much data is missing
miss_case_table(data) #For each 'n' of missing data, tells us how many rows have 'n' missing data

#Some visualizations
gg_miss_var(data)
vis_miss(data)
missing_plot(data)

#Less than 5% missing data, which is good
#Missing data for winner seed and loser seed is appropriate because not everyone is seeded during a tournament

#The winner entry variable actually does have missing values
#For seeded players, we will designate "S" for seeded 
data$winner_entry <- ifelse(is.na(data$winner_seed) == F, "S", data$winner_entry)
data$loser_entry <- ifelse(is.na(data$loser_seed) == F, "S", data$loser_entry)

#Replace any blank values with NAs
data <- data %>% 
  replace_with_na_at(.vars = c("winner_entry", "loser_entry"),
                     condition = ~.x == "")

#For some reason, heights are missing for a lot of people...let's inspect and isolate all unique missing heights for winners and losers 
missing_winner_heights <- data %>% select(winner_name, winner_ht) %>% filter(is.na(winner_ht) == T)
missing_winner_heights <- unique(missing_winner_heights$winner_name)

missing_loser_heights <- data %>% select(loser_name, loser_ht) %>% filter(is.na(loser_ht) == T)
missing_loser_heights <- unique(missing_loser_heights$loser_name)

missing_all_heights <- c(missing_winner_heights, missing_loser_heights)
missing_all_heights <- sort(unique(missing_all_heights))

#For the rest of the missing variables, it's NA due to a walk over or retirement

```

##Filling in missing heights

```{r}
#In python I'd create a dictionary, we will use the equivalent here
#Had to manually look up heights on google which was really annoying and still had some NA's. Tried to pull heights from ATP website whenever possible.

dict = list(
"Adolfo Daniel Vallejo"= NA,
"Adrian Andreev"= 180,
"Alastair Gray"= 188,
"Alejandro Tabilo"= 188,
"Aleksandar Vukic"= 188,
"Alex Bolt"= 183,
"Alex Molcan"= 178,
"Alexandar Lazarov"= 191,
"Alexander Erler"= 193,
"Alexander Sarkissian"= 191,
"Alexander Zgirovsky"= 191,
"Alexandre Muller"= 183,
"Alexandros Skorilas"= 185,
"Alibek Kachmazov"= 185,
"Altug Celikbilek"= 183,
"Andrea Arnaboldi"= 175,
"Andrea Collarini"= 185,
"Andrea Vavassori"= 191,
"Andrew Harris"= 183,
"Antoine Hoang"= 183,
"Aqeel Khan"= NA,
"Arthur Cazaux"= 183,
"Arthur Rinderknech"= 196,
"August Holmgren"= 188,
"Aziz Dougaz"= 188,
"Aziz Ouakaa"= NA,
"Benjamin Bonzi"= 183,
"Benjamin Hassan"= 183,
"Benjamin Lock"= 198,
"Bernabe Zapata Miralles"= 183,
"Bjorn Fratangelo"= 183,
"Blake Mott"= 180,
"Bor Artnak"= NA,
"Borna Gojo"= 196,
"Botic Van De Zandschulp"= 191,
"Brandon Nakashima"= 188,
"Brandon Perez"= 191,
"Brayden Schnur"= 193,
"Carlos Taberner"= 183,
"Christian Harrison"= 180,
"Christian Sigsgaard"= 193,
"Christopher Eubanks"= 201,
"Constant Lestienne"= 180,
"Dane Sweeny"= 170,
"Daniel Altmaier"= 188,
"Daniel Cukierman"= NA,
"Daniel Masur"= 183,
"Daniil Glinka"= 185,
"Daniil Ostapenkov"= NA,
"Danilo Petrovic"= 203,
"Dimitri Badra"= NA,
"Dmitry Popko"= 191,
"Duje Ajdukovic"= 188,
"Edgars Manusis"= NA,
"Eduardo Nava"= 180,
"Emilio Gomez"= 185,
"Emilio Nava"= 185,
"Enzo Couacaud"= 183,
"Ergi Kirkin"= 180,
"Erik Arutiunian"= NA,
"Ernesto Escobedo"= 185,
"Evgenii Tiurnev"= 191,
"Fabian Marozsan"= 191,
"Facundo Diaz Acosta"= 183,
"Federico Coria"= 180,
"Federico Gaio"= 178,
"Felipe Meligeni Alves"= 185,
"Filip Cristian Jianu"= 180,
"Filip Horansky"= 191,
"Finn Reynolds"= NA,
"Flavio Cobolli"=NA,
"Francisco Cerundolo"= 185,
"Francisco Llanes"= 175,
"Frederico Ferreira Silva"= 178,
"Gerardo Lopez Villasenor"= 191,
"Giulio Zeppieri"= 183,
"Gunawan Trismuwantara"= NA,
"Hady Habib"= 188,
"Hamad Medjedovic"= 185,
"Harry Bourchier"= 185,
"Hernando Jose Escurra Isnardi"= NA,
"Holger Rune"= 188,
"Hugo Gaston"= 173,
"Hugo Grenier"= 196,
"Ignacio Carou"= 178,
"J J Wolf"= 183,
"Jack Draper"= 193,
"Jason Jung"= 180,
"Jason Kubler"= 178,
"Jay Clarke"= 183,
"Jc Aragone"= 178,
"Jenson Brooksby"= 193,
"Jerome Kym"= 198,
"Ji Sung Nam"= 183,
"Jiri Lehecka"= 185,
"Jisung Nam"= 183,
"Joao Menezes"= 185,
"Johan Nikles"= 173,
"Johannes Ingildsen"= 193,
"John Patrick Smith"= 188,
"Juan Ignacio Londero"= 180,
"Juan Manuel Cerundolo"= 183,
"Juan Pablo Varillas"= 185,
"Jurij Rodionov"= 191,
"Justin Barki"= NA,
"Kacper Zuk"= 183,
"Kaichi Uchida"= 180,
"Kaipo Marshall"= 191,
"Kamil Majchrzak"= 180,
"Kasidit Samrej"= NA,
"Kevin King"= 191,
"Khumoun Sultanov"= 180,
"Li Tu"= 180,
"Liam Broady"= 183,
"Lluis Miralles"= 191,
"Lorenzo Giustino"= 180,
"Lucas Catarina"= 185,
"Luis Patino"= 183,
"Lukas Klein"= 193,
"Luke Saville"= 188,
"Mackenzie Mcdonald"= 178,
"Marc Andrea Huesler"= 196,
"Marc Polmans"= 188,
"Marco Trungelliti"= 178,
"Mario Vilella Martinez"= 178,
"Marko Topo"= 188,
"Martin Antonio Vergara Del Puerto"= NA,
"Martin Cuevas"= 191,
"Matheus Pucinelli De Almeida"= 183,
"Mathias Bourgue"= 188,
"Mats Moraing"= 198,
"Mattias Siimar"= NA,
"Max Purcell"= 185,
"Maximilian Marterer"= 188,
"Mehluli Don Ayanda Sibanda"= 173,
"Michael Geerts"= 178,
"Michael Mmoh"= 188,
"Michael Vrbensky"= 183,
"Michail Pervolarakis"= 193,
"Mikael Torpegaard"= 193,
"Mitchell Krueger"= 188,
"Mubarak Shannan Zayid"= NA,
"Murkel Alejandro Dellien Velasco"= 193,
"Muzammil Murtaza"= NA,
"Nerman Fatic"= 191,
"Nick Hardt"= NA,
"Nicola Kuhn"= 185,
"Nicolas Alvarez"= 185,
"Nicolas Kicker"= 178,
"Nicolas Mejia"= 183,
"Nino Serdarusic"= 191,
"Noah Rubin"= 175,
"Nuno Borges"= 185,
"Orlando Luz"= NA,
"Oscar Otte"= 193,
"Otto Virtanen"= 191,
"Patrik Niklas Salminen"= 185,
"Pavel Kotov"= 191,
"Pedja Krstin"= 183,
"Pedro Martinez"= 185,
"Petros Tsitsipas"= 183,
"Philip Henning"= NA,
"Prajnesh Gunneswaran"= 188,
"Quentin Halys"= 191,
"Raul Brancaccio"= 185,
"Ricardo Rodriguez"= NA,
"Robert Strombachs"= 191,
"Roberto Cid"= 193,
"Roberto Marcora"= 193,
"Roey Tabet"= NA,
"Roman Safiullin"= 185,
"Ruan Roelofse"= 188,
"Rudolf Molleker"= 185,
"Sam Riffice"= 188,
"Sanjar Fayziev"= 190,
"Sebastian Baez"= 170,
"Sebastian Dominko"= NA,
"Sebastian Ofner"= 191,
"Shintaro Mochizuki"= NA,
"Siim Troost"= NA,
"Stefan Kozlov"= 183,
"Steven Diez"= 175,
"Sumit Nagal"= 178,
"Tallon Griekspoor"= 188,
"Thabo Ncube"= NA,
"Thai Son Kwiatkowski"= 188,
"Thiago Agustin Tirante"= 188,
"Thiago Seyboth Wild"= 185,
"Thomas Fabbiano"= 173,
"Thomas Fancutt"= 188,
"Timofey Skatov"= 175,
"Tom Kocevar Desman"= 180,
"Tomas Barrios Vera"= 191,
"Tomas Machac"= 183,
"Tomas Martin Etcheverry"= 196,
"Trent Bryde"= 183,
"Tristan Lamasine"= 183,
"Tristan Schoolkate"= 183,
"Tung Lin Wu"= 188,
"Vilius Gaubas"= NA,
"Vit Kopriva"= 178,
"Vitaliy Sachko"= 183,
"Vladimir Ivanov"= NA,
"Wishaya Trongcharoenchaikul"= 193,
"Wojciech Marek"= 191,
"Yosuke Watanuki"= 180,
"Yshai Oliel"= 188,
"Yuta Shimizu"= 163,
"Zachary Svajda"= 175,
"Zizou Bergs"= 185,
"Zsombor Piros"= 180)

dict <- dict %>% as_tibble() 
heights_df <- pivot_longer(dict, cols = everything())
colnames(heights_df) <- c("Name", "Height")

#Fill in the missing winner heights
data2 <- left_join(data, heights_df, by = c("winner_name" = "Name"))
data2$winner_ht <- dplyr::coalesce(data2$winner_ht, data2$Height)

#Fill in the missing loser heights
data3 <- left_join(data2, heights_df, by = c("loser_name" = "Name"), suffix = c("_orig", "_dupe"))
data3$loser_ht <- dplyr::coalesce(data3$loser_ht, data3$Height_dupe)

#Let's check
table(is.na(data$winner_ht))
table(is.na(data3$winner_ht))

table(is.na(data$loser_ht))
table(is.na(data3$loser_ht))

#We got rid of lots of NA's!
#Now let's drop the Height_orig and Height_dupe vars since we don't need them anymore
data3 <- select(data3, -c("Height_orig", "Height_dupe"))
```


```{r}
#Let's re-examine the missingness
miss_var_summary(data3) %>% View() #This is pretty much the same info as the missing df

#Some visualizations
gg_miss_var(data3)
vis_miss(data3)

```

##Data clean up and feature extraction

```{r}
##We want to make a variable for matches that were walked over or retired
data3$ret <- ifelse(data3$score == "W/O" | grepl("RET", data3$score), "Yes", "No")

##We want to make a feature for each set's score
##We have to extract the set score 
##Make a copy of score variable
data3$score_full <- data3$score
data3 <- separate(data3, score_full, into = c("set_1", "set_2", "set_3", "set_4", "set_5"), sep = " ")

data3 <- data3 %>% replace_with_na(replace = list(set_1 = c("RET", "W/O"), set_2 = "RET", set_3 = "RET", set_4 = "RET", set_5 = "RET"))

data3 %>% select(score, set_1, set_2, set_3, set_4, set_5) %>% View()

##We want to make a feature that states IF a TB occurred and if so, how many for the winner and how many for the loser
data3$num_tbs <- str_count(data3$score, fixed("("))
data3$winner_tb_num <- str_count(data3$score, fixed("7-6"))
data3$loser_tb_num <- str_count(data3$score, fixed("6-7"))

##We want to make a feature for each set's TB score if it occurred
data3$set_1_tb_score <- as.numeric(regmatches(data3$set_1, gregexpr("(?<=\\().*?(?=\\))", data3$set_1, perl=T)))
data3$set_2_tb_score <- as.numeric(regmatches(data3$set_2, gregexpr("(?<=\\().*?(?=\\))", data3$set_2, perl=T)))
data3$set_3_tb_score <- as.numeric(regmatches(data3$set_3, gregexpr("(?<=\\().*?(?=\\))", data3$set_3, perl=T)))
data3$set_4_tb_score <- as.numeric(regmatches(data3$set_4, gregexpr("(?<=\\().*?(?=\\))", data3$set_4, perl=T)))
data3$set_5_tb_score <- as.numeric(regmatches(data3$set_5, gregexpr("(?<=\\().*?(?=\\))", data3$set_5, perl=T)))

##We want to make a feature saying if the winner or the loser of the match won the tiebreaks of each set
data3$set_1_tb_won <- ifelse(grepl("7-6", data3$set_1), "Winner", ifelse(grepl("6-7", data3$set_1), "Loser", NA))
data3$set_2_tb_won <- ifelse(grepl("7-6", data3$set_2), "Winner", ifelse(grepl("6-7", data3$set_2), "Loser", NA))
data3$set_3_tb_won <- ifelse(grepl("7-6", data3$set_3), "Winner", ifelse(grepl("6-7", data3$set_3), "Loser", NA))
data3$set_4_tb_won <- ifelse(grepl("7-6", data3$set_4), "Winner", ifelse(grepl("6-7", data3$set_4), "Loser", NA))
data3$set_5_tb_won <- ifelse(grepl("7-6|13-12", data3$set_5), "Winner", ifelse(grepl("6-7|12-13", data3$set_5), "Loser", NA))

#Need to make a variable stating if EACH set went to a TB or not 
data3$set_1_had_tb <- ifelse(grepl("7-6", data3$set_1), "Yes", ifelse(grepl("6-7", data3$set_1), "Yes", "No"))
data3$set_2_had_tb <- ifelse(grepl("7-6", data3$set_2), "Yes", ifelse(grepl("6-7", data3$set_2), "Yes", "No"))
data3$set_3_had_tb <- ifelse(grepl("7-6", data3$set_3), "Yes", ifelse(grepl("6-7", data3$set_3), "Yes", "No"))
data3$set_4_had_tb <- ifelse(grepl("7-6", data3$set_4), "Yes", ifelse(grepl("6-7", data3$set_4), "Yes", "No"))
data3$set_5_had_tb <- ifelse(grepl("7-6|13-12", data3$set_5), "Yes", ifelse(grepl("6-7|12-13", data3$set_5), "Yes", "No"))

#Let's check if all these variables make sense
data3 %>% select(score, set_1, set_1_had_tb, set_1_tb_score, set_1_tb_won) %>% View()
#They do!

```

#EDA: Who won the most matches in 2021?

```{r}

#Let's isolate the top 20 players with the most wins in 2021
win_data <- data %>% select(winner_name) %>% group_by(winner_name) %>% count(sort = TRUE) 
win_data <- head(win_data, 20)

#Let's plot them 
winners_plot <- ggplot(win_data) + 
  geom_col(mapping = aes(x=reorder(winner_name, -n), y=n), fill='firebrick') + 
  geom_text(mapping = aes(x=reorder(winner_name, -n), y=n, label=n), vjust=-0.5) +
  theme(axis.text.x=element_text(angle=60, hjust=1)) + 
  ggtitle("Top 20 Most ATP Match Wins in 2021") + 
  xlab("Player") + 
  ylab("Number of Wins")
  
winners_plot
```

#EDA: If the first set goes to a tiebreak, how often does the winner of the first set tiebreak win the match? Is this significant, or due to random chance?

```{r}

#Filter out cases where first set went to TB
first_set_tb <- data3 %>% filter(set_1_had_tb == "Yes")

#Create a variable stating the first set TB winner won the match AS NUMERIC
first_set_tb$set_1_tb_won_numeric <- as.numeric(as.factor(first_set_tb$set_1_tb_won)) - 1

#We can look at the raw number here 
addmargins(table(first_set_tb$set_1_tb_won_numeric))
addmargins(table(first_set_tb$set_1_tb_won))
377/506

#Run a binomial test to see if this is different from random chance (seems like it is)
binom.test(377, 506, 0.5)

```

#EDA: If the first set goes to a tiebreak, how often does the winner get a second set get a bagel or breadstick?

```{r}

#Create variable for second set bakery
first_set_tb$second_set_bakery <- ifelse(grepl("6-0|6-1", first_set_tb$set_2), "Bakery", "No")

addmargins(table(first_set_tb$second_set_bakery))
print(48/506)

#Over ALL of the second sets that DID NOT follow a tiebreak, how often does bakery happen
#Use a reference proportion

data3$second_set_bakery <- ifelse(grepl("6-0|6-1", data3$set_2), "Bakery", "No")
data3$second_set_bakery <- as.factor(data3$second_set_bakery)
data3$second_set_bakery <- relevel(data3$second_set_bakery, ref = "No")
data3$second_set_bakery_numeric <- as.numeric(data3$second_set_bakery) - 1

data3$set_1_had_tb <- as.factor(data3$set_1_had_tb)
data3$set_1_tb_won <- as.factor(data3$set_1_tb_won)


first_set_no_tb <- data3 %>% filter(set_1_had_tb == "No")
first_set_no_tb$second_set_bakery <- ifelse(grepl("6-0|6-1", first_set_no_tb$set_2), "Bakery", "No")
addmargins(table(first_set_no_tb$second_set_bakery))
print(220/2221)

#Seems like the rates of second set bagel or breadstick are independent of whether there was a first set tiebreak (9.5% versus 9.9%)
#We can do a z test of proportions for this - p.value is 0.839 which is not significant
prop.test(x = c(48, 220), n = c(506, 2221), alternative='two.sided')

```


#EDA: How tall are players in the ATP? 

```{r}

#Distribution of heights
ggplot(heights_df, mapping=aes(x=Height)) + 
  geom_histogram(bins = 20)

ggplot(heights_df) +
  geom_density(aes(x=Height), alpha = 0.5, color="darkblue", fill="lightblue") +
  geom_vline(aes(xintercept=mean(Height, na.rm = T)), color="darkblue", linetype="dashed", size=1) +
  geom_text(x = 184, y = 0.02, label = "Mean Height = 185.4 or 6'1''", angle = 90) +
  ggtitle("Density Distribution of Player Heights (2021)") + 
  xlab("Player Height (cm)") + 
  ylab("Density") +
  theme_minimal() 


```


##Comments
```{r}
#Rows that are strange and must be inspected
#957
#2716
```

##To further explore 
```{r}

#How often in best of 5 does the winner of first set lose
#1. Create variable for each set's winner and loser

#How often does someone come back from being match point down and then go on to win the match 

#How often does someone serve below 50% and still win the match 

#How many times does someone have more errors and still win
#More errors that winners or more errors than their opponent?

#I’d also want to see how many times someone hasn’t dropped a single set and then gone on to win the slam 
```

##Data Dictionary
```{r}
# * Many of the columns in the 'matches' files are self-explanatory, or are very similar to previous columns.
# 
# tourney_id
# - a unique identifier for each tournament, such as 2020-888. The exact formats are borrowed from several different sources, so while the first four characters are always the year, the rest of the ID doesn't follow a predictable structure.
# 
# tourney_name
# surface
# draw_size
# - number of players in the draw, often rounded up to the nearest power of 2. (For instance, a tournament with 28 players may be shown as 32.)
# 
# tourney_level
# - For men: 'G' = Grand Slams, 'M' = Masters 1000s, 'A' = other tour-level events, 'C' = Challengers, 'S' = Satellites/ITFs, 'F' = Tour finals and other season-ending events, and 'D' = Davis Cup 

# - For women, there are several additional tourney_level codes, including 'P' = Premier, 'PM' = Premier Mandatory, and 'I' = International. The various levels of ITFs are given by the prize money (in thousands), such as '15' = ITF $15,000. Other codes, such as 'T1' for Tier I (and so on) are used for older WTA tournament designations. 'D' is used for Federation/Fed/Billie Jean King Cup, and also for Wightman Cup and Bonne Bell Cup.
# 
# - Others, eventually for both genders: 'E' = exhibition (events not sanctioned by the tour, though the definitions can be ambiguous), 'J' = juniors, and 'T' = team tennis, which does yet appear anywhere in the dataset but will at some point.
# 
# tourney_date
# - eight digits, YYYYMMDD, usually the Monday of the tournament week.
# 
# match_num
# - a match-specific identifier. Often starting from 1, sometimes counting down from 300, and sometimes arbitrary. 
# 
# winner_id
# - the player_id used in this repo for the winner of the match
# 
# winner_seed
# winner_entry
# - 'WC' = wild card, 'Q' = qualifier, 'LL' = lucky loser, 'PR' = protected ranking, 'ITF' = ITF entry, and there are a few others that are occasionally used.
# 
# winner_name
# winner_hand
# - R = right, L = left, U = unknown. For ambidextrous players, this is their serving hand.
# winner_ht
# - height in centimeters, where available
# 
# winner_ioc
# - three-character country code
# 
# winner_age
# - age, in years, as of the tourney_date
# 
# loser_id
# loser_seed
# loser_entry
# loser_name
# loser_hand
# loser_ht
# loser_ioc
# loser_age
# score
# best_of
# - '3' or '5', indicating the the number of sets for this match
# 
# round
# minutes
# - match length, where available
# 
# w_ace
# - winner's number of aces
# w_df
# - winner's number of doubles faults
# w_svpt
# - winner's number of serve points
# w_1stIn
# - winner's number of first serves made
# w_1stWon
# - winner's number of first-serve points won
# w_2ndWon
# - winner's number of second-serve points won
# w_SvGms
# - winner's number of serve games
# w_bpSaved
# - winner's number of break points saved
# w_bpFaced
# - winner's number of break points faced
# 
# l_ace
# l_df
# l_svpt
# l_1stIn
# l_1stWon
# l_2ndWon
# l_SvGms
# l_bpSaved
# l_bpFaced
# 
# winner_rank
# - winner's ATP or WTA rank, as of the tourney_date, or the most recent ranking date before the tourney_date
# winner_rank_points
# - number of ranking points, where available
# loser_rank
# loser_rank_points
# 
# * _doubles_ files notes
# 
# The matches_doubles files have similar columns, though not all in the same order.
# 
# The identifying information for each player refers to 'winner1', 'winner2', 'loser1', and 'loser2'. The labels 1 and 2 are not assigned for any particular reason.
# 
# In general, the tournament IDs for doubles results are the same as for singles results (so, for instance, you can see which players entered both draws at the same event), though this is not guaranteed for every single tournament, since some of the data came from different sources.
# 
# The stats columns ('w_ace' etc) are per *team*, not per player. That's a function of how tennis stats are typically recorded, not a decision on my part.
```

##Info from Ultimate Tennis Statistics
```{r}
#https://hub.docker.com/r/mcekovic/uts-database
#https://github.com/mcekovic/tennis-crystal-ball/issues
```

